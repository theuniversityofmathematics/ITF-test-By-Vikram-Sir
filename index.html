<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>Combined Quizzes — The University Of Mathematics</title>

<!-- ===== CONFIG: paste your links here (already filled with yours) ===== -->
<script>
  const GOOGLE_SHEET_WEB_APP = "https://script.google.com/macros/s/AKfycbyoaHk245G-A1mjcdk7fOqIdWbF1hY9dFe0rgIjMbzPgSDTR6AEm8GYqKWZlR55VGRO/exec";
  const GOOGLE_SHEET_VIEW_URL = "https://docs.google.com/spreadsheets/d/1C6Bnw2_wgkXXKs1sI9knZRPKK3fRtNmXhRi9wQB5nsQ/edit?usp=sharing";
</script>
<!-- =================================================================== -->

<style>
  body { font-family: Arial, sans-serif; background:#fffbe6; margin:0; padding:18px; }
  .wrap { max-width:1000px; margin:0 auto; }
  h1 { text-align:center; margin-bottom:6px; }
  fieldset { background:#fff; border:1px solid #ccc; padding:12px; border-radius:8px; margin-bottom:12px; }
  legend { font-weight:700; }
  input[type=text], input[type=password] { padding:8px; width:60%; max-width:360px; }
  button { padding:8px 12px; margin-left:6px; background:#f0c040; border:none; border-radius:6px; cursor:pointer; }
  #timer { font-size:18px; color:#b71c1c; font-weight:700; text-align:center; margin-bottom:8px; }
  .option { display:block; margin:8px 0; }
  #resultCard { background:#fff; border:2px solid #ccc; padding:12px; border-radius:8px; margin-top:12px; }
  .answer-summary { font-family:monospace; white-space:pre-wrap; text-align:left; margin-top:10px; }
  .correct { color:#117a37; font-weight:700; }
  .wrong { color:#c62828; font-weight:700; }
  table { width:100%; border-collapse:collapse; margin-top:12px; background:#fff; }
  th, td { border:1px solid #aaa; padding:8px; text-align:center; }
  .controls { text-align:center; margin-top:10px; }
  .small { font-size:13px; color:#444; }
  a.link-button { display:inline-block; padding:8px 12px; background:#7fb3ff; color:#000; border-radius:6px; text-decoration:none; margin-left:6px; }
</style>
</head>
<body>
<div class="wrap">
  <h1>The University Of Mathematics (Maths by Vikram Sir)</h1>

  <!-- Password screen -->
  <div id="passwordScreen">
    <fieldset>
      <legend>Access</legend>
      <input id="accessPwd" type="password" placeholder="Enter password">
      <button onclick="onPasswordEnter()">Enter</button>
    </fieldset>
  </div>

  <!-- Name input for student -->
  <div id="nameScreen" style="display:none;">
    <fieldset>
      <legend>Student Details</legend>
      <label class="small">Name: <input id="studentName" type="text" placeholder="Enter your name"></label>
      <button onclick="startQuiz()">Start Test</button>
    </fieldset>
  </div>

  <!-- Quiz area -->
  <div id="quizScreen" style="display:none;">
    <div id="timer"></div>
    <div id="questionBox"></div>
    <div class="controls">
      <button id="nextBtn" onclick="onNext()">Next</button>
    </div>

    <div id="resultCard" style="display:none;">
      <h2>Test Result</h2>
      <p id="studentInfo" class="small"></p>
      <p id="scoreInfo" class="small"></p>
      <div id="summary" class="answer-summary"></div>
      <div class="controls">
        <button onclick="printResult()">Print Result</button>
      </div>
    </div>
  </div>

  <!-- Admin screen -->
  <div id="adminScreen" style="display:none;">
    <fieldset>
      <legend>Admin — Stored Results (local)</legend>
      <table>
        <thead><tr><th>Name</th><th>Test</th><th>Score</th><th>Date</th><th>Quiz Code</th></tr></thead>
        <tbody id="adminTable"></tbody>
      </table>
      <div class="controls" style="margin-top:10px;">
        <button onclick="downloadLocalCSV()">Download Local CSV</button>
        <button onclick="clearLocalResults()">Clear Local Results</button>
        <a id="openSheetBtn" class="link-button" target="_blank" href="#">Open Google Sheet</a>
      </div>
    </fieldset>
  </div>
</div>

<script>
/* ============================
   QUIZ BANKS (with shuffle)
   ============================ */
const BANK = {
  "1508": { title:"Indian GK — Freedom Movement (20 Q, shuffled)", questions: [
    {q:"In which year did India attain independence?", options:["1942","1945","1947","1950"], ans:"c"},
    {q:"Who gave the call of 'Quit India' in 1942?", options:["Mahatma Gandhi","Jawaharlal Nehru","Sardar Patel","Subhas Chandra Bose"], ans:"a"},
    {q:"The Jallianwala Bagh massacre took place in:", options:["1915","1919","1921","1930"], ans:"b"},
    {q:"Who founded the Indian National Army (INA)?", options:["Lala Lajpat Rai","Rashbehari Bose","Bhagat Singh","Subhas C. Bose"], ans:"b"},
    {q:"Which act is called the 'Montagu–Chelmsford Reforms'?", options:["Indian Councils Act 1909","Government of India Act 1919","Rowlatt Act 1919","GOI Act 1935"], ans:"b"},
    {q:"Who wrote 'Hind Swaraj'?", options:["B. R. Ambedkar","Bal Gangadhar Tilak","M. K. Gandhi","Rabindranath Tagore"], ans:"c"},
    {q:"Who was known as the 'Iron Man of India'?", options:["Bhagat Singh","Sardar Patel","Lala Lajpat Rai","Bipin Chandra Pal"], ans:"b"},
    {q:"Who gave the slogan 'Swaraj is my birthright'?", options:["Tilak","Gandhi","Nehru","Bose"], ans:"a"},
    {q:"Who formed the Forward Bloc in 1939?", options:["Nehru","Patel","Bose","Tilak"], ans:"c"},
    {q:"Where was the Non-Cooperation Movement launched?", options:["Bombay","Calcutta","Ahmedabad","Delhi"], ans:"b"},
    {q:"Kakori Conspiracy (1925) is associated with:", options:["HSRA","HRA","INA","Anushilan Samiti"], ans:"b"},
    {q:"The Lahore Session (1929) of INC declared:", options:["Swaraj","Dominion Status","Purna Swaraj","Separate Electorates"], ans:"c"},
    {q:"The Dandi March started on:", options:["Jan 26, 1930","Mar 12, 1930","Apr 6, 1930","Aug 9, 1942"], ans:"b"},
    {q:"Simon Commission came to India in:", options:["1927","1928","1929","1930"], ans:"b"},
    {q:"Who authored 'Anand Math'?", options:["Bankim Chandra Chatterjee","Sarojini Naidu","Aurobindo Ghosh","Premchand"], ans:"a"},
    {q:"Bhagat Singh, Rajguru and Sukhdev were executed in:", options:["1929","1930","1931","1932"], ans:"c"},
    {q:"The 'Poona Pact' (1932) was signed between:", options:["Gandhi & Jinnah","Gandhi & Ambedkar","Nehru & Ambedkar","Patel & Ambedkar"], ans:"b"},
    {q:"Who was the first Governor-General of independent India?", options:["Mountbatten","C. Rajagopalachari","Nehru","Patel"], ans:"a"},
    {q:"Who composed 'Vande Mataram'?", options:["Bankim Chandra Chatterjee","Rabindranath Tagore","Iqbal","Subramania Bharati"], ans:"a"},
    {q:"Champaran Satyagraha (1917) was related to:", options:["Textile workers","Indigo planters","Salt tax","Railway strike"], ans:"b"},
  ]},

  /* You can add back your math banks here if you like (codes 200, 100, 300) */
  "200": { title:"Inverse Trig (Principal Value)", questions:[
    {q:'Principal value of sin⁻¹(√3/2) is:', options:['π/3','2π/3','π/6','−π/3'], ans:'a'},
    {q:'Principal value of cos⁻¹(1/2) is:', options:['π/3','2π/3','π/6','−π/3'], ans:'a'},
    {q:'Principal value of tan⁻¹(1) is:', options:['π/4','3π/4','−π/4','π/2'], ans:'a'},
    {q:'Principal value of cot⁻¹(1) is:', options:['π/4','3π/4','π/2','−π/4'], ans:'a'},
    {q:'Principal value of sec⁻¹(2) is:', options:['π/3','2π/3','π/6','−π/3'], ans:'a'},
    {q:'Principal value of csc⁻¹(2) is:', options:['π/6','5π/6','π/3','−π/6'], ans:'a'},
    {q:'Principal value of sin⁻¹(−1/2) is:', options:['−π/6','π/6','5π/6','−5π/6'], ans:'a'},
    {q:'Principal value of cos⁻¹(−1/2) is:', options:['2π/3','4π/3','π/3','−π/3'], ans:'a'},
    {q:'Principal value of tan⁻¹(−1) is:', options:['−π/4','3π/4','π/4','−3π/4'], ans:'a'},
    {q:'Principal value of sin⁻¹(0) is:', options:['0','π/2','π','−π/2'], ans:'a'},
    {q:'Principal value of cos⁻¹(0) is:', options:['π/2','0','π','−π/2'], ans:'a'},
    {q:'Principal value of tan⁻¹(√3) is:', options:['π/3','π/6','2π/3','−π/3'], ans:'a'},
    {q:'Principal value of cot⁻¹(√3) is:', options:['π/6','π/3','5π/6','−π/6'], ans:'a'},
    {q:'Principal value of sec⁻¹(−2) is:', options:['2π/3','−π/3','π/3','−2π/3'], ans:'a'},
    {q:'Principal value of csc⁻¹(−2) is:', options:['−π/6','π/6','5π/6','−5π/6'], ans:'a'},
    {q:'Principal value of sin⁻¹(1) is:', options:['π/2','−π/2','0','π'], ans:'a'},
    {q:'Principal value of cos⁻¹(1) is:', options:['0','π','π/2','−π/2'], ans:'a'},
    {q:'Principal value of tan⁻¹(0) is:', options:['0','π/2','π','−π/2'], ans:'a'},
    {q:'Principal value of cot⁻¹(0) is:', options:['π/2','0','π','−π/2'], ans:'a'},
    {q:'Principal value of sin⁻¹(−1) is:', options:['−π/2','π/2','0','−π'], ans:'a'}
  ]},
};

/* -------------------------
   runtime state
   ------------------------- */
let chosenCode = '';
let chosenQuiz = null;
let prepared = [];
let qList = [];
let current = 0;
let studentAnswers = [];
let studentName = '';
let timerId = null;
let timeLeft = 30;

/* -------------------------
   helpers
   ------------------------- */
function shuffle(arr){
  for(let i=arr.length-1;i>0;i--){
    const j=Math.floor(Math.random()*(i+1));
    [arr[i],arr[j]]=[arr[j],arr[i]];
  }
  return arr;
}

function prepareQuestions(raw){
  return raw.map(item=>{
    const origCorrectIdx = item.ans.charCodeAt(0)-97;
    const pairs = item.options.map((t,i)=>({text:t, orig:i}));
    shuffle(pairs);
    const correctAfter = pairs.findIndex(p=>p.orig===origCorrectIdx);
    return {
      q: item.q,
      options: pairs.map(p=>p.text),
      correct: String.fromCharCode(97 + correctAfter),
      correctText: pairs[correctAfter].text
    };
  });
}

/* -------------------------
   password -> choose quiz
   ------------------------- */
function onPasswordEnter(){
  const p = document.getElementById('accessPwd').value.trim();
  if(!p){ alert('Enter password'); return; }
  if(p === '9110'){ openAdmin(); return; }
  if(!BANK[p]){ alert('Wrong password'); return; }
  chosenCode = p;
  chosenQuiz = BANK[p];

  // Prepare: shuffle options and pick a randomized order of all questions
  prepared = prepareQuestions(chosenQuiz.questions);
  qList = shuffle(prepared.slice()); // full set shuffled

  document.getElementById('passwordScreen').style.display = 'none';
  document.getElementById('nameScreen').style.display = 'block';
}

/* -------------------------
   start quiz
   ------------------------- */
function startQuiz(){
  const nm = document.getElementById('studentName').value.trim();
  if(!nm){ alert('Enter name'); return; }
  studentName = nm;
  studentAnswers = Array(qList.length).fill(null);
  current = 0;
  document.getElementById('nameScreen').style.display = 'none';
  document.getElementById('quizScreen').style.display = 'block';
  renderQuestion();
}

/* -------------------------
   show question, start timer
   ------------------------- */
function renderQuestion(){
  clearInterval(timerId);
  timeLeft = 30; // 30s per question
  document.getElementById('timer').textContent = `Time Left: ${timeLeft}s`;
  timerId = setInterval(()=>{
    timeLeft--;
    document.getElementById('timer').textContent = `Time Left: ${timeLeft}s`;
    if(timeLeft <= 0){ clearInterval(timerId); onNext(); }
  }, 1000);

  const q = qList[current];
  const box = document.getElementById('questionBox');
  box.innerHTML = '';
  let html = `<fieldset><legend>Q${current+1}) ${escapeHtml(q.q)}</legend>`;
  q.options.forEach((opt,i)=>{
    const letter = String.fromCharCode(97 + i);
    html += `<label class="option"><input type="radio" name="opt" value="${letter}"> (${letter}) ${escapeHtml(opt)}</label>`;
  });
  html += `</fieldset>`;
  box.innerHTML = html;
  document.getElementById('nextBtn').textContent = current === qList.length-1 ? 'Submit' : 'Next';
}

/* -------------------------
   next or submit
   ------------------------- */
function onNext(){
  const sel = document.querySelector('input[name="opt"]:checked');
  if(sel) studentAnswers[current] = sel.value;
  if(current === qList.length-1){ submitQuiz(); return; }
  current++;
  renderQuestion();
}

/* -------------------------
   submit & show summary
   ------------------------- */
function submitQuiz(){
  clearInterval(timerId);
  // compute score and HTML summary with colored marks
  let score = 0, attempted = 0;
  let html = '<div><strong>Answer Summary</strong></div><br>';
  qList.forEach((q, idx)=>{
    const sLetter = studentAnswers[idx];
    const sText = sLetter ? q.options[sLetter.charCodeAt(0)-97] : null;
    const cLetter = q.correct;
    const cText = q.correctText;
    const correct = sLetter && sLetter === cLetter;
    if(sLetter) attempted++;
    if(correct) score++;
    const studentPart = !sLetter ? `<span>Not Attempted</span>` :
      (correct ? `<span class="correct">(${sLetter.toUpperCase()}) ${escapeHtml(sText)}</span>` :
                 `<span class="wrong">(${sLetter.toUpperCase()}) ${escapeHtml(sText)}</span>`);
    const correctPart = `<span class="correct">(${cLetter.toUpperCase()}) ${escapeHtml(cText)}</span>`;
    html += `<div><strong>Q${idx+1}.</strong> ${escapeHtml(q.q)}<br>Your: ${studentPart} &nbsp; | &nbsp; Correct: ${correctPart}</div><br>`;
  });

  // reveal result
  document.getElementById('questionBox').style.display = 'none';
  document.getElementById('nextBtn').style.display = 'none';
  document.getElementById('timer').style.display = 'none';
  const res = document.getElementById('resultCard');
  res.style.display = 'block';
  document.getElementById('studentInfo').textContent = `Name: ${studentName}   |   Test: ${chosenQuiz.title}`;
  document.getElementById('scoreInfo').textContent = `Score: ${score} / ${qList.length}   |   Attempted: ${attempted}`;
  document.getElementById('summary').innerHTML = html;

  // save to Google Sheet (server), also store locally for admin local view
  const record = {
    name: studentName,
    test: chosenQuiz.title,
    score,
    date: new Date().toLocaleString(),
    quizCode: chosenCode
  };
  saveToGoogleSheet(record).then(()=>{
    saveLocally(record);
  }).catch(()=>{
    saveLocally(record);
  });
}

/* -------------------------
   save: Google Apps Script doPost + localStorage
   ------------------------- */
async function saveToGoogleSheet(record){
  if(!GOOGLE_SHEET_WEB_APP){ throw new Error('No Web App URL'); }
  const resp = await fetch(GOOGLE_SHEET_WEB_APP, {
    method: 'POST',
    headers: { 'Content-Type': 'application/json' },
    body: JSON.stringify({ name:record.name, score:record.score, date:record.date, quizCode:record.quizCode })
  });
  if(!resp.ok) throw new Error('Network error');
  return true;
}

function saveLocally(record){
  try{
    const list = JSON.parse(localStorage.getItem('quizResults') || '[]');
    list.push(record);
    localStorage.setItem('quizResults', JSON.stringify(list));
  }catch(e){ console.error('Local save failed', e); }
}

/* -------------------------
   Admin UI (local results)
   ------------------------- */
function openAdmin(){
  document.getElementById('passwordScreen').style.display = 'none';
  document.getElementById('adminScreen').style.display = 'block';
  const openBtn = document.getElementById('openSheetBtn');
  if(GOOGLE_SHEET_VIEW_URL){
    openBtn.href = GOOGLE_SHEET_VIEW_URL;
    openBtn.style.display = 'inline-block';
  } else {
    openBtn.style.display = 'none';
  }
  refreshAdminTable();
}

function refreshAdminTable(){
  const tbody = document.getElementById('adminTable');
  const list = JSON.parse(localStorage.getItem('quizResults') || '[]');
  tbody.innerHTML = '';
  list.forEach(r=>{
    const tr = document.createElement('tr');
    tr.innerHTML = `<td>${escapeHtml(r.name)}</td><td>${escapeHtml(r.test)}</td><td>${escapeHtml(String(r.score))}</td><td>${escapeHtml(r.date)}</td><td>${escapeHtml(r.quizCode||'')}</td>`;
    tbody.appendChild(tr);
  });
}

function downloadLocalCSV(){
  const list = JSON.parse(localStorage.getItem('quizResults') || '[]');
  let csv = 'Name,Test,Score,Date,Quiz Code\n';
  list.forEach(r=>{
    csv += `"${(r.name||'').replace(/"/g,'""')}","${(r.test||'').replace(/"/g,'""')}",${r.score},"${(r.date||'').replace(/"/g,'""')}","${(r.quizCode||'').replace(/"/g,'""')}"\n`;
  });
  const blob = new Blob([csv], { type:'text/csv' });
  const url = URL.createObjectURL(blob);
  const a = document.createElement('a');
  a.href = url;
  a.download = 'quiz_results_local.csv';
  document.body.appendChild(a);
  a.click();
  a.remove();
  URL.revokeObjectURL(url);
}

function clearLocalResults(){
  if(!confirm('Clear all local results? This cannot be undone.')) return;
  localStorage.removeItem('quizResults');
  refreshAdminTable();
}

/* -------------------------
   small utilities
   ------------------------- */
function escapeHtml(s){ if(s===null||s===undefined) return ''; return String(s).replace(/&/g,'&amp;').replace(/</g,'&lt;').replace(/>/g,'&gt;'); }
function printResult(){ window.print(); }

/* -------------------------
   keyboard enter support
   ------------------------- */
document.addEventListener('keydown', (e)=>{
  if(e.key === 'Enter'){
    const pwdVisible = document.getElementById('passwordScreen').style.display !== 'none';
    const nameVisible = document.getElementById('nameScreen').style.display !== 'none';
    if(pwdVisible){ onPasswordEnter(); e.preventDefault(); }
    else if(nameVisible){ startQuiz(); e.preventDefault(); }
  }
});
</script>
</body>
</html>
